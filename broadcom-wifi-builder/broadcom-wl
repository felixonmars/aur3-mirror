#!/bin/bash

. /etc/rc.conf
. /etc/rc.d/functions

LOG="/var/log/broadcom-wl-install.log"

case "$1" in
setup)
	echo "Target system: `uname -s` `uname -r`" > $LOG
	NEED_ATTENTION=0
	stat_busy "Unloading module: wl"
	if grep -q "^wl" /proc/modules; then
		modprobe -r wl
	fi
	stat_done

	WD=`pwd`
	cd /usr/src/broadcom-wl

	stat_busy "Building module: wl"
	echo "[Building wl at `date`]" >> $LOG
	make API=WEXT -C /lib/modules/$(uname -r)/build M=`pwd` >> $LOG 2>&1
	[ $? -eq 0 ] && stat_done || { stat_fail; NEED_ATTENTION=1; }

	stat_busy "Installing module in `uname -r`: wl"
	rm -f /lib/modules/$(uname -r)/kernel/drivers/net/wireless/wl.{ko,ko.gz} > /dev/null 2>&1
	install -D -m 644 wl.ko /lib/modules/$(uname -r)/kernel/drivers/net/wireless/wl.ko && stat_done || stat_fail

	stat_busy "Compressing module in `uname -r`: wl"
	gzip /lib/modules/$(uname -r)/kernel/drivers/net/wireless/wl.ko && stat_done || stat_fail

	stat_busy "Cleaning up sources"
	echo "[Cleaning wl at `date`]" >> $LOG
	make API=WEXT -C /lib/modules/$(uname -r)/build M=`pwd` clean >> $LOG 2>&1
	[ $? -eq 0 ] && stat_done || { stat_fail; NEED_ATTENTION=1; }

	cd "$WD"

	stat_busy "Updating module dependencies for `uname -r`"
	depmod $(uname -r) && stat_done || stat_fail

	if [ $NEED_ATTENTION -gt 0 ]; then
		echo "Errors occured. Please see $LOG for more information."
	else
		if grep -q "^b43" /proc/modules; then
			stat_busy "Unloading module: b43"
			modprobe -r b43 && stat_done || stat_fail
		fi

		if grep -q "^ssb" /proc/modules; then
			stat_busy "Unloading module: ssb"
			modprobe -r ssb && stat_done || stat_fail
		fi

		if grep -q "^bcma" /proc/modules; then
			stat_busy "Unloading module: bcma"
			modprobe -r bcma && stat_done || stat_fail
		fi

		stat_busy "Loading module: wl"
		modprobe wl && stat_done || stat_fail
	fi
;;
clean)
	for p in /lib/modules/*; do
		if [ ! -f "$p/modules.builtin" ]; then
			if [ -e "$p/kernel/drivers/net/wireless/wl.ko" -o -e "$p/kernel/drivers/net/wireless/wl.ko.gz" ]; then
				stat_busy "Removing old module form $p: wl"
				rm -f "$p/kernel/drivers/net/wireless/wl.ko" 2>/dev/null
				rm -f "$p/kernel/drivers/net/wireless/wl.ko.gz" 2>/dev/null
				rmdir -p --ignore-fail-on-non-empty "$p/kernel/drivers/net/wireless/" 2>/dev/null
				stat_done
			fi
		fi
	done
;;
*)
	echo "usage: $0 {setup|clean}"
;;
esac

