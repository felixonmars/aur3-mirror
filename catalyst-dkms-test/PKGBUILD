# Maintainer: Jameson Pugh <imntreal@gmail.com>
# Contributor: Laurent Carlier <lordheavym@gmail.com>
# Contributor: Vi0L0, wonder, Eduardo "kensai" Romero
# Contributor: aidanlinz, Rip-Rip, OvsInc, Sebastian Siebert

pkgname=catalyst-dkms-test
pkgver=13.6
pkgrel=1
pkgdesc="AMD proprietary gpu kernel driver"
arch=('i686' 'x86_64')
url="http://www.amd.com"
license=('custom')
depends=('dkms')
optdepends=('linux-headers: build the module against Arch kernel'
            'linux-lts-headers: build the module against LTS Arch kernel')
conflicts=('catalyst' 'catalyst-dkms')
provides=('catalyst')
source=("http://www2.ati.com/drivers/beta/amd-driver-installer-catalyst-${pkgver/./-}-beta-x86.x86_64.zip"
        'dkms.conf')
install=catalyst.install
sha256sums=('3e1bd2ac2d2fcf7188c9e365f77b0c27fc71d788618ab9b2cbf86d0d48e8b63a'
            '6b304e0b826ccd11942b3d4993063eaf41879f38b9eccce90e69253f6ec64816')

package() {
  depends=(${depends[@]} "catalyst-utils-test=${pkgver}")

  cd ${srcdir}
  
  if [ "${CARCH}" = "x86_64" ]; then
    _archdir=x86_64
  else
    _archdir=x86
  fi

  sh ./amd-*.run --extract fglrx-install

  cd fglrx-install

  install -dm755 "${pkgdir}/usr/lib/modprobe.d"
  install -dm755 "${pkgdir}/usr/src/fglrx-${pkgver}-${pkgrel}"
  cp -r common/lib/modules/fglrx/build_mod/* "${pkgdir}/usr/src/fglrx-${pkgver}-${pkgrel}/"
  cp "arch/${_archdir}"/lib/modules/fglrx/build_mod/libfglrx_ip.a "${pkgdir}/usr/src/fglrx-${pkgver}-${pkgrel}/"
  cp ${srcdir}/dkms.conf "${pkgdir}/usr/src/fglrx-${pkgver}-${pkgrel}/"
  sed -i -e "s/@VERSION@/${pkgver}-${pkgrel}/" "${pkgdir}/usr/src/fglrx-${pkgver}-${pkgrel}/dkms.conf"
  
  echo "blacklist radeon" >> "${pkgdir}/usr/lib/modprobe.d/catalyst.conf"
  
  # license
  install -Dm644 "common/usr/share/doc/fglrx/LICENSE.TXT" "${pkgdir}/usr/share/licenses/${pkgname}/LICENSE.TXT"
}
