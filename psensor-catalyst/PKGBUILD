# Maintainer: X0rg

pkgname=psensor-catalyst
_pkgname=psensor
pkgver=0.8.0.3
pkgrel=1
pkgdesc="Psensor is a graphical hardware temperature monitor for Linux with AMD proprietary driver support."
arch=('i686' 'x86_64')
url="http://wpitchoune.net/psensor"
license=('GPL' 'AMD-ADL')
depends=('lm_sensors' 'gconf' 'pango' 'gtk3')
makedepends=('gtk3<3.8')
optdepends=('libnotify: support for notifications')
conflicts=('xf86-video-ati' 'xf86-video-intel' 'xf86-video-nouveau' 'nvidia-304xx' 'nvidia-173xx' 'nvidia-96xx')

source=("http://wpitchoune.net/psensor/files/$_pkgname-$pkgver.tar.gz")
source2=("http://developer.amd.com/amd-license-agreement/?f=ADL_SDK_5.0.zip") # Not necessary, it's only real source.
md5sums=('f44579b92e1327c75c1582e464bfafac')

_gitroot="git://github.com/X0rg/AMD_ADL_SDK.git"
_gitname="AMD_ADL_SDK"

build() {
	cd "$srcdir/$_pkgname-$pkgver"
	msg "Connecting to GIT server...."

	if [[ -d "$_gitname" ]]; then
		cd "$_gitname" && git pull origin
		msg "The local files are updated."
		cd "$srcdir/$_pkgname-$pkgver"
	else
		git clone "$_gitroot" "$_gitname"
	fi

	msg "GIT checkout done or server timeout"
	msg "Starting build..."

	msg "Copy some librairies for compilation..."
	cp $srcdir/$_pkgname-$pkgver/$_gitname/include/adl_defines.h 	$srcdir/$_pkgname-$pkgver/src/lib
	cp $srcdir/$_pkgname-$pkgver/$_gitname/include/adl_sdk.h 	$srcdir/$_pkgname-$pkgver/src/lib
	cp $srcdir/$_pkgname-$pkgver/$_gitname/include/adl_structures.h $srcdir/$_pkgname-$pkgver/src/lib

	msg "Configure..."
	./configure --with-libatiadl=$_gitname --prefix=/usr
	msg "Compile..."
	make clean all -j1 # With '-jN' where N>1, there are errors.
}

package() {
	cd "$srcdir/$_pkgname-$pkgver"
	make DESTDIR="$pkgdir" install
}
