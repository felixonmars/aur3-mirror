# Maintainer: Anish Bhatt anish [at] gatech [dot] edu

pkgname='pipelight'
pkgver=1
_relver=3
pkgrel=15
#epoch=1
pkgdesc="A browser plugin which allows one to use windows only plugins inside Linux browser"
url="https://launchpad.net/pipelight"
arch=('i686' 'x86_64')
license=('GPL2' 'LGPL2.1' 'MPL')

depends=('wine-silverlight' 'wine-browser-installer' 'ttf-ms-fonts' 'wget')
if  [[ "$CARCH" == "x86_64" ]]; then
  depends+=('lib32-libsm')
else
  depends+=('libsm')
fi

# Set value to 1 if you want to compile pluginloader yourself
_compilepluginloader=0

if [[ $_compilepluginloader != 0 ]]; then
  if [[ "$CARCH" == "x86_64" ]]; then
  makedepends=('mingw-w64-gcc')
  else
  makedepends=('mingw32-gcc')
  fi
fi

makedepends+=('cabextract')

source=("https://bitbucket.org/mmueller2012/pipelight/get/v0.$pkgver-$_relver.tar.bz2"
  "https://launchpad.net/pipelight/trunk/0.1/+download/pluginloader-prebuilt-v0.$pkgver-$_relver.tar.gz"
  "wine-silverlight5.1-installer.exe::http://silverlight.dlservice.microsoft.com/download/B/3/C/B3CF6815-40B1-4E36-8746-C4A0381AD260/20513.00/runtime/Silverlight.exe"
  "addlib.cab::http://download.microsoft.com/download/8/0/D/80D7E79D-C0E4-415A-BCCA-E229EAFE2679/dshow_nt.cab"
  "install-dependency-pipelight")

md5sums=('ddc9a2d2c37e80353a0cd3eb9f6e29d0'
         '9f64f839b5de974581012a50bf4ea688'
         '971894515dd26a26175883031521d8b3'
         '366d44b9e0f667dec11f9bc16f31cc79'
         '4c9f2e90ad90c29b7b17e1128aad1ed9')

install=pipelight.install

_srcdir=mmueller2012-pipelight-d7249e0ffaab

#this changes the install location for the pipelight executables
_prefix=/usr

#change this if your wine-silverlight is installed elsewhere, or if you prefer a different wine directory
_wine=/usr
_wineprefix=.wine-pipelight

prepare() {
  pushd $_srcdir

  #The next two lines can't be used if you want to compile your own pluginloader.exe
  if [[ $_compilepluginloader == 0 ]]; then
    sed -i '1s|src/windows||g' Makefile
    sed -i '16d' Makefile
    sed -i '54s|gccRun|#gccRun|g' share/pipelight
  fi

  pushd src/windows
  sed -i '2 a\ CXXFLAGS        := -static-libgcc -static-libstdc++ $(CXXFLAGS)' Makefile
  popd
  pushd share
  sed -i "25s|/opt/wine-compholio|$_wine|g" pipelight
  sed -i "s|PLUGIN_LOADER_PATH|$_prefix/share/pipelight/pluginloader.exe|g" pipelight
  sed -i "s|wine-browser-installer|wine-silverlight|g" pipelight
  sed -i "119s|wine-silverlight/install-dependency|wine-silverlight/install-dependency-pipelight|g" pipelight

  # embed bug fixed, this is no longer needed
  #sed -i '76s|true|false|g' pipelight

  #in case you want to use 64bit wine, you would need this
  #if [[ "$CARCH" == "x86_64" ]]; then
  #  sed -i 's|Files|Files (x86)|g' pipelight
  #fi

  # this needs to change if you're using a custom prefix for wine-silverlight, will happen automatically if _wineprefix changed
  sed -i "30s|.wine-pipelight|$_wineprefix|g" pipelight
  popd
  cd ..

  _home='$HOME'/$_wineprefix
  sed -i "1 a\WINE=$_wine/bin/wine" install-dependency-pipelight
  sed -i "2 a\INSTDIR=$_prefix/share/pipelight" install-dependency-pipelight
  sed -i "3 a\WINEPREFIX=$_home" install-dependency-pipelight
  #if [[ "$CARCH" == "x86_64" ]]; then
  #  sed -i 's|Files|Files (x86)|g' wine-silverlight5.1-installer.install-script
  #fi

  cabextract addlib.cab
  popd
}

build() {
  pushd $_srcdir
  ./configure --prefix=$_prefix
  make
  popd
}

package() {
  make -C $_srcdir PREFIX=$_prefix DESTDIR=$pkgdir install
  install -Dm644 wine-silverlight5.1-installer.exe ${pkgdir}/$_prefix/share/pipelight/.
  install -dm755 ${pkgdir}/usr/share/wine-silverlight/.
# install -Dm755 wine-silverlight5.1-installer.install-script ${pkgdir}/usr/share/wine-silverlight/.
  install -Dm755 install-dependency-pipelight ${pkgdir}/usr/share/wine-silverlight/.

  if [[ $_compilepluginloader  == 0 ]]; then
    install -Dm644 l*.dll ${pkgdir}/$_prefix/share/pipelight/.
    install -Dm644 pluginloader.exe ${pkgdir}/$_prefix/share/pipelight/.
  fi

  install -Dm644 mpg2splt.ax ${pkgdir}/$_prefix/share/pipelight/.
}

# vim:set ts=2 sw=2 et:
