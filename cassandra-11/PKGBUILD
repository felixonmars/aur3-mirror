# Maintainer: Radim Kolar <hsn@sendmail.cz>
# Contributor: Marko Tasic <mtasic85@gmail.com>
# Contributor: Thomas Dziedzic <gostrc@gmail.com>
# Contributor: Konstantin Nikiforov <helllamer@gmail.com>
# Thanks to Alper Kanat <alperkanat@raptiye.org> for cassandra rc.d script. 

# check() function is used to verify GPG signature. check() imports 3 keys into your GPG keyring at first build.
# See http://scarybeastsecurity.blogspot.com/2011/07/alert-vsftpd-download-backdoored.html for reason of this step.
# If you have problems with gpg, you can remove check() function, and all will be ok.

pkgname=cassandra-11
pkgname2=cassandra
pkgver=1.1.12
pkgrel=1
pkgdesc="NoSQL database (precompiled official version)"
arch=('any')
url="http://cassandra.apache.org/"
license=('APACHE')
depends=('java-runtime-headless>=6')
makedepends=('gnupg' 'curl' 'ca-certificates')
url_tgz="http://apache.mirror.anlx.net/$pkgname2/$pkgver/apache-$pkgname2-$pkgver-bin.tar.gz"
url_sig="http://www.apache.org/dist/$pkgname2/$pkgver/apache-$pkgname2-$pkgver-bin.tar.gz.asc"
source=($url_tgz cassandra.rc.d cassandra.service.systemd)
sha1sums=('a4f7e9a3e6d4f9bec6c40153735c3fbf8cec0dd9'
          'bd1df4e24101f8a35d9143a6a945b283731f07db'
          'e0116963336f26d7596cbbda746f750e08075de9'
)
backup=(usr/share/cassandra/conf/cassandra.yaml)
## to check gpg signature
check() {
	msg "Checking GPG signature..."
        msg2 "(To disable gpg-check: remove/rename check() function from/in PKGBUILD code.)"
	gpg --list-keys | grep 'sylvain@datastax.com' || {
		url_keys='https://www.apache.org/dist/cassandra/KEYS'
		msg "No maintainers' GPG keys found. Importing from $url_keys ..."
		curl --silent -o - $url_keys | gpg --import -
	}
	# no need to add signature to package dependences
	echo "Downloading signature from $url_sig"
	curl --silent -o - "$url_sig" | gpg --verify - "apache-$pkgname2-$pkgver-bin.tar.gz"
	msg2 "Detached GPG signature is valid."
}

package() {
    install -D -m755 cassandra.rc.d $pkgdir/etc/rc.d/cassandra
    install -D -m644 ${srcdir}/cassandra.service.systemd \
                 ${pkgdir}/lib/systemd/system/cassandra.service

	cd $srcdir/apache-cassandra-${pkgver}

	mkdir -p ${pkgdir}/var/{lib,log}/cassandra
	mkdir -p ${pkgdir}/usr/bin
	mkdir -p ${pkgdir}/usr/share/cassandra

	sed -i 's_`dirname $0`/.._/usr/share/cassandra_' bin/cassandra.in.sh

	chown http:http ${pkgdir}/var/{lib,log}/cassandra
        chown http:log ${pkgdir}/var/log/cassandra

	cp -a {lib,conf,interface} ${pkgdir}/usr/share/cassandra/

	cd bin

	install \
		cassandra \
		cassandra-cli \
		json2sstable \
		nodetool \
		sstable2json \
		sstablekeys \
		${pkgdir}/usr/bin/

	install \
		cassandra.in.sh \
		${pkgdir}/usr/share/cassandra/
}
