# Maintainer: Myles English <myles at rockhead.biz>
# Contributor: Feng Wang <wanng.fenng@gmail.com>

pkgname=trilinos
pkgver=10.6.4
pkgrel=2
pkgdesc="The Trilinos Project is an effort to develop algorithms and enabling technologies within an object-oriented software framework for the solution of large-scale, complex multi-physics engineering and scientific problems."
arch=(any)
url="http://trilinos.sandia.gov/index.html"
license=('LGPL3')
depends=()
source=(http://trilinos.sandia.gov/download/files/${pkgname}-${pkgver}-Source.tar.gz
        patch.diff)
makedepends=('python2' 'gcc' 'mpich2' 'perl' 'blas' 'lapack')
md5sums=( '75b393e633bde4d9565df304f84b52e4'
          'e9523add6812c0dc8db622e10366a3a2' )

build() {
  cd "$srcdir/$pkgname-$pkgver-Source"

  patch -Np1 -i ${startdir}/patch.diff

  [[ -e build ]] || mkdir build 
  cd build
  #EXTRA_ARGS=$@

cmake \
    .. \
    -DCMAKE_BUILD_TYPE:STRING=DEBUG \
    -DMPI_BASE_DIR:PATH="/opt/mpich2" \
    -DTPL_ENABLE_MPI:BOOL=ON \
    -DTrilinos_ENABLE_ALL_PACKAGES:BOOL=ON \
    -DTrilinos_ENABLE_ALL_OPTIONAL_PACKAGES:BOOL=ON \
    -DML_ENABLE_Aztec:BOOL=ON \
    -DTrilinos_ENABLE_PyTrilinos:BOOL=ON \
    -DTrilinos_ENABLE_Belos:BOOL=OFF \
    -DTrilinos_ENABLE_TESTS:BOOL=OFF \
    -DBUILD_SHARED_LIBS:BOOL=ON \
    -DPYTHON_EXECUTABLE:PATH=/usr/bin/python2 \
    -DML_ENABLE_MLapi:BOOL=ON \
    -DCMAKE_INSTALL_PREFIX:PATH=/usr \
    $EXTRA_ARGS

#    -DPyTrilinos_INSTALL_PREFIX:PATH=/usr/lib/python2.7 \
#PyTrilinos_INSTALL_DIR:PATH=/usr/lib/python2.7/site-packages/PyTrilinos

# trying to fix dolfin/la/TrilinosPreconditioner.cpp:155:3: error: ‘SetDefaults’ is not a member of ‘ML_Epetra’
#        -DML_ENABLE_Aztec:BOOL=ON # no effect
          #-D Trilinos_ENABLE_rythmos:BOOL=OFF
    #ML_ENABLE_Aztec2_1:BOOL=ON      # doesn't compile
    #ML_ENABLE_Cfunc:BOOL=OFF        # doesn't compile
          #-D Trilinos_ENABLE_nox:BOOL=OFF

    make
}


package() {
    cd $srcdir/$pkgname-$pkgver-Source/build
    make install DESTDIR=$pkgdir

    mkdir -p ${pkgdir}/etc/profile.d
    echo "export TRILINOS_DIR=/usr" > ${pkgdir}/etc/profile.d/trilinos.sh
    chmod +x ${pkgdir}/etc/profile.d/trilinos.sh
}
