# Maintainer: György Balló <ballogy@freestart.hu>
pkgname=gwibber-bzr
_pkgname=gwibber
pkgver=1214
pkgrel=1
pkgdesc="Microblogging client for GNOME, which supports Twitter, Identi.ca, StatusNet, Facebook, Flickr, Digg, FriendFeed and Qaiku"
arch=(i686 x86_64)
url="http://gwibber.com/"
license=(GPL)
depends=(libgee 'dee>=0.5.18-2' json-glib gtkspell3 dbus-python gnome-keyring python-gnomekeyring python-notify python-wnck python-egenix-mx-base python2-oauth python-imaging python-pycurl python-simplejson pywebkitgtk pyxdg xdg-utils)
makedepends=(bzr gnome-common 'vala>=0.14' 'intltool>=0.35.0' 'gobject-introspection>=0.10')
provides=(gwibber)
conflicts=(gwibber)
options=(!libtool)
install=$_pkgname.install
source=(gwibber-no-unity.patch
        fix-build.patch
        launchpad-export.tar.gz)
md5sums=(aa21539a23f68566d25d1f2937577d27
         ecfe30d25c7a6ea8d2c32bd0e0cd628e
         e2461293ef2eba418ffea75af64c41c7)

_bzrtrunk="lp:gwibber"
_bzrmod="gwibber"

build() {
  cd "$srcdir"
  msg "Connecting to Bazaar server...."

  if [ -d $_bzrmod ] ; then
    cd ${_bzrmod} && bzr pull ${_bzrtrunk} -r ${pkgver}
    msg "The local files are updated."
  else
    bzr branch ${_bzrtrunk} ${_bzrmod} -r ${pkgver}
  fi

  msg "Bazaar checkout done or server timeout"
  msg "Starting make..."

  rm -rf "$srcdir/$_bzrmod-build"
  cp -r "$srcdir/$_bzrmod" "$srcdir/$_bzrmod-build"
  cd "$srcdir/$_bzrmod-build"

  #
  # BUILD HERE
  #

  # Really disable Unity
  patch -Np1 -i "$srcdir/gwibber-no-unity.patch"

  # Fix build
  patch -Np1 -i "$srcdir/fix-build.patch"

  # Install updated language files
  echo 'af an ar ast az be bg bn br bs ca ca@valencia cy cs da de dv el en_AU en_CA en_GB eo es et eu fa fi fil fr fy ga gl gu he hi hr hu hy ia id is it ja ka kk km kn ko ku lb lo lt lv mg mk ml mn mr ms nb nl nn oc pa pl pt pt_BR ro ru si sk sl sq sr sv ta te th tr tt ug uk vi yo zh_CN zh_HK zh_TW zza' >po/LINGUAS
  rename $_pkgname- '' ../po/$_pkgname-*.po
  mv -f -t po ../po/*

  # python2 fix
  find . -type f | xargs sed -i 's@^#!.*python$@#!/usr/bin/python2@'

  ./autogen.sh --prefix=/usr --sysconfdir=/etc --localstatedir=/var \
                --disable-static --disable-schemas-compile --disable-unity
  make
  make DESTDIR="$pkgdir" install
}
