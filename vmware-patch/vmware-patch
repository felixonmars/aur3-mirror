#!/bin/bash

KERNEL=`uname -r | sed 's/-.*//'`
VMWARE="/usr/lib/vmware/patches/"

timestamp=`date +%Y%m%d-%H%M%S`
if [ `whoami` != "root" ]
then
  echo "This need to be run as root"
  exit 1
fi

cd $VMWARE

echo "Not patching vmware modconfig libraries (not required since vmware player/workstation 8.0)"
#echo "Patching vmware modconfig libraries:"
#if [ `echo $KERNEL | cut -f 1 -d "."` -eq 3 ] ; then
#  for mod in `echo \
#/usr/lib/vmware/lib/libvmware-modconfig-console.so/libvmware-modconfig-console.so  \
#/usr/lib/vmware/lib/libvmware-modconfig.so/libvmware-modconfig.so \
#`
#  do
#    echo "* Patching "`basename ${mod}`"..."
#    cp "${mod}" "${mod}".bak
#    sed 's/\x83\xe8\x03\x83\xf8\x01\x0f\x96\xc0/\x83\xe8\x02\x83\xf8\x01\x0f\x96\xc0/' -i ${mod} && echo "  Patch success"
#  done
#
#else
#  echo "* Kernel 3.X is not being used. No patch required."
#fi

echo "Patching vmware modules source code:"
for mod in `ls *-${KERNEL}.diff | sed "s/-${KERNEL}.diff//"`
do
  echo "* Patching ${mod} ..."
  SRC="/usr/lib/vmware/modules/source/${mod}.tar"
  cp ${SRC} ${SRC}-${timestamp}
  tar -xf ${SRC}
  cd ${mod}-only
  patch -p1 < ../${mod}-${KERNEL}.diff
  res=$?
  cd ..
  if [ $res -ne 0 ]
  then
    echo "  [${mod}-only] Failed to apply patch"
    rm -rf ${mod}-only
    exit 1
  else
    echo "  [${mod}-only] Patch applied successfully"
  fi

  tar cf ${mod}.tar ${mod}-only
  cp ${mod}.tar ${SRC}
  rm -rf ${mod}.tar ${mod}-only
done
