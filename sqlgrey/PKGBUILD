# Maintainer: Phillip Smith <fukawi2@NO-SPAM.gmail.com>
# http://github.com/fukawi2/aur-packages

### I AM ONLY THE PACKAGER, NOT THE DEVELOPER
### Please ask support questions about this software in one of:
###   1) The AUR comments; OR
###   2) Upstream forums/maillist etc; OR
###   3) The ArchLinux forums
### I do not always know enough about the software itself, or don't have the
### time to promptly respond to direct emails.
### If you have found a problem with the package/PKGBUILD (as opposed to
### the software) then please do email me or post an AUR comment.

pkgname=sqlgrey
pkgver=1.8.0
pkgrel=1
pkgdesc="Postfix greylisting policy service with auto-white-listing written in Perl with SQL database as storage backend. Greylisting stops 50 to 90 % junk mails (spam and virus) before they reach your Postfix server (saves BW, user time and CPU time)."
arch=('any')
url="http://sqlgrey.sourceforge.net/"
license=('GPL')
depends=('perl' 'perl-net-server' 'perl-io-multiplex' 'perl-dbi' 'perl-date-calc' 'postfix>=2.1')
optdepends=('perl-dbd-pg: for using postgresql as backend database' 'perl-dbd-mysql: for using mysql as backend database')
backup=('etc/sqlgrey/sqlgrey.conf' 'etc/sqlgrey/clients_ip_whitelist.local' 'etc/sqlgrey/clients_fqdn_whitelist.local')
install=$pkgname.install
source=("http://downloads.sourceforge.net/project/sqlgrey/sqlgrey-1.8%20%28stable%29/$pkgname-$pkgver.tar.gz"
        "rc.$pkgname")
md5sums=('de9c6d0740fd2589d4e353e76c40e2c7'
         '028c1b536ef89fa2eb6cbc7fb4708395')

build() {
  # UID / GID 111 = sqlgrey
	cd $srcdir/$pkgname-$pkgver

	make
}

package() {
	cd $srcdir/$pkgname-$pkgver

  make ROOTDIR=${pkgdir} install
	
  msg "Installing rc.d script..."
  install -D -m755 $srcdir/rc.$pkgname $pkgdir/etc/rc.d/$pkgname
  
  msg "Creating .local config files..."
  touch $pkgdir/etc/sqlgrey/clients_ip_whitelist.local
  touch $pkgdir/etc/sqlgrey/clients_fqdn_whitelist.local
  cat > $pkgdir/etc/sqlgrey/clients_ip_whitelist.local <<EOD
  # This is the local configuration for whitelisted IP addresses for sqlgrey.
  # Add any IP addresses you need whitelisted to this file. One IP address per line.
  # To add a /24 address space, omit the last octet of the address.
  # For example, to whitelist 202.14.166.0/24, add the line:
  #   202.14.166
EOD

  cat > $pkgdir/etc/sqlgrey/clients_fqdn_whitelist.local <<EOD
  # This is the local configuration for whitelisted hostnames for sqlgrey.
  #
  # hostname.domain.com # whole system name (least CPU intensive)
  # *.domain.com        # whitelist any fqdn in the domain 'domain.com'
  # /regexp/            # whitelist any fqdn matching the regexp (by far most CPU intensive)

  # Note you need the following two lines to allow both
  # <lots of mtas>.example.com and example.com
  # *.example.com
  # example.com 
EOD

  msg "Setting permissions..."
  chown -R 111:111 $pkgdir/etc/sqlgrey

  msg "Cleaning up..."
  rm -Rf $pkgdir/etc/init.d
}

# vim:set ts=2 sw=2 et:
