# Contributor: Michael Asher <michael at wesolveeverything [dot] com>
# Maintainer: Michael Asher <michael at wesolveeverything [dot] com>
#
pkgname=ironbee-git
pkgdesc="Open-Source Web Application Firewall"
url="https://www.ironbee.com"
pkgver=20111007
pkgrel=2
arch=('any')
license=('APACHE')
options=('makeflags' '!ccache' '!libtool')
depends=('apache' 'libhtp-git' )
source=('mod_ironbee.conf')
md5sums=('6aec65343e39f016753ba2be7b6027c1')
install=(${pkgname}.install)

_gitroot="http://github.com/ironbee/ironbee.git"
_gitname="ironbee"

build() {
  cd "${srcdir}"
  msg "Pulling source from ${_gitroot}"

  if [ -d $_gitname ] ; then
    msg2 "Local Repo Exists. Updating local files"
    cd $_gitname && git pull origin >> /dev/null 2>&1
  else
    git clone $_gitroot $_gitname >> /dev/null 2>&1
  fi

  rm -rf "$srcdir/$_gitname-build"
  git clone "$srcdir/$_gitname" "$srcdir/$_gitname-build" >> /dev/null 2>&1
  cd "$srcdir/$_gitname-build"
  msg2 "Fetching additional modules"
  git submodule init >> /dev/null 2>&1 
  git submodule update >> /dev/null 2>&1
  msg "Generating \'configure\' files"
  ./autogen.sh >> /dev/null 2>&1
  msg "Running configure scripts"
  ./configure --prefix=/usr >> /dev/null 2>&1
  #
  # For some reason running a 'make' here fails unless I compile the luajit release first.
  #
  msg "Compiling sources"
  cd libs
  cd luajit-2.0-ironbee 
  make amalg >> /dev/null 2>&1
  cd .. 
  cd ..
  make >> /dev/null 2>&1 
  make check  >> /dev/null 2>&1
  msg "Generating Documentation"
  make manual >> /dev/null 2>&1
  make doxygen >> /dev/null 2>&1
  make DESTDIR=${pkgdir} install >> /dev/null 2>&1
  msg "Installing to \$pkgdir"
  install -Dm644 LICENSE ${pkgdir}/usr/share/licenses/${pkgname}/LICENSE
  mkdir -p ${pkgdir}/usr/share/doc/${pkgname}
  cp -r docs/docbook/manual/output/* ${pkgdir}/usr/share/doc/${pkgname}/
  cd ${srcdir}
  install -Dm644 mod_ironbee.conf ${pkgdir}/etc/httpd/conf/extra/mod_ironbee.conf
} 
# vim: ts=2 sw=2 et:
