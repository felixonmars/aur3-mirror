# Contributor: Szymon Jakubczak szym-at-mit-dot-edu
pkgname=openafs
pkgver=1.4.14
pkgrel=1
pkgdesc="An open source client for the AFS distributed file system"
arch=('i686' 'x86_64')
url="http://www.openafs.org"
license=('custom:"IBM Public License Version 1.0"')
depends=(heimdal 'kernel26-headers>=2.6.28-0')
makedepends=(bison flex)
backup=(etc/openafs/ThisCell
        etc/openafs/cacheinfo
        etc/openafs/afs.conf
        etc/openafs/afs.conf.client
        etc/openafs/CellServDB)
install=openafs.install
source=(http://openafs.org/dl/openafs/$pkgver/$pkgname-$pkgver-src.tar.bz2
        openafs.rc)
md5sums=('e26d2e894999a18a47a9cf8bbfbaadb2'
         '85fa92bdd773085c850ced56fbb76021')


build() {
  cd $startdir/src/$pkgname-$pkgver

  _kernelver=$(uname -r)

  ./regen.sh
  ./configure --prefix=/usr --sysconfdir=/etc --with-krb5-conf

  sed -i 's/all: aklog asetkey/all: aklog/' $startdir/src/$pkgname-$pkgver/src/aklog/Makefile
  sed -i 's/${DESTDIR}${afssrvbindir}\/asetkey//' $startdir/src/$pkgname-$pkgver/src/aklog/Makefile

  make
  make DESTDIR=$startdir/pkg install

  mv $startdir/pkg/usr/bin/afs_compile_et $startdir/pkg/usr/bin/compile_et-openafs
  mv $startdir/pkg/usr/bin/kpasswd $startdir/pkg/usr/bin/kpasswd-openafs
  mv $startdir/pkg/usr/bin/pagsh $startdir/pkg/usr/bin/pagsh-openafs

  mkdir -p $startdir/pkg/lib/modules/$_kernelver/fs
  mkdir -p $startdir/pkg/etc/rc.d
  mkdir -p $startdir/pkg/etc/openafs/cachedir
  mkdir -p $startdir/pkg/usr/share/licenses/$pkgname

  cp $startdir/pkg/usr/lib/openafs/libafs-$_kernelver.mp.ko $startdir/pkg/lib/modules/$_kernelver/fs/libafs.ko || \
  cp $startdir/pkg/usr/lib/openafs/libafs-$_kernelver.ko    $startdir/pkg/lib/modules/$_kernelver/fs/libafs.ko

  # i686 only
  mkdir -p $startdir/pkg/lib/security
  cp $startdir/pkg/usr/lib/pam_afs.krb.so.1 $startdir/pkg/usr/lib/pam_afs.so.1 $startdir/pkg/lib/security/ || true

  cp $startdir/src/$pkgname.rc $startdir/pkg/etc/rc.d/$pkgname
  chmod u+x $startdir/pkg/etc/rc.d/$pkgname

  cp $startdir/src/$pkgname-$pkgver/src/WINNT/install/wix/CellServDB $startdir/pkg/etc/$pkgname/
  cp $startdir/src/$pkgname-$pkgver/src/afsd/afs.conf.linux $startdir/pkg/etc/$pkgname/afs.conf

  cat >> $startdir/pkg/etc/$pkgname/afs.conf.client << EOF
AFS_CLIENT=true
AFS_AFSDB=true
AFS_CRYPT=true
AFS_DYNROOT=true
AFS_FAKESTAT=true
EOF

  cat >> $startdir/pkg/etc/$pkgname/cacheinfo << EOF
/afs:/etc/openafs/cachedir:30000
EOF

  cat >> $startdir/pkg/etc/$pkgname/ThisCell << EOF
andrew.cmu.edu
EOF

  chmod 700 $startdir/pkg/etc/$pkgname/cachedir
  chown root.root $startdir/pkg/etc/$pkgname/cachedir

  cp $startdir/src/$pkgname-$pkgver/src/LICENSE $startdir/pkg/usr/share/licenses/$pkgname
}
