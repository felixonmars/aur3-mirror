pkgname=modsecurity27-apache
_pkgname=modsecurity-apache
pkgver=2.7.2
pkgrel=4
pkgdesc='ModSecurity web application firewall for Apache (and Nginx!) with Core Rule Set'
arch=('i686' 'x86_64')
depends=('apr' 'apr-util' 'pcre' 'libxml2' 'lua')
makedepends=('curl' 'git' 'apache')
provides=("$_pkgname=$pkgver")
conflicts=("$_pkgname")
url="http://www.modsecurity.org"
license=('GPL2' 'Apache')
install=modsecurity.install
source=(http://www.modsecurity.org/tarball/${pkgver}/${_pkgname}_${pkgver}.tar.gz
        nginx.buildconfig)
sha256sums=('2fa43264e3aa024d29869eada3171a2aba19fc05180860fd84c7a6ebfd1f2854'
            'c2fa893eb30e64651f352a7a5bb7db64635661e3762d1353e023055db1e446c0')

_builddir="$srcdir"/${_pkgname}_${pkgver}

_gitrepo="git://github.com/SpiderLabs/owasp-modsecurity-crs.git"
_gitbase="crs"

build() {
	msg "Building ModSecurity"

	cd "$_builddir"
	./configure \
		--prefix=/usr \
		--libdir=/usr/lib/modsecurity \
		--includedir=/usr/include/modsecurity \
		--enable-standalone-module \
		--enable-extentions \
		--enable-alp2 \
		--enable-pcre-study \
		--enable-pcre-jit \
		--enable-lua-cache \
		--enable-performance-measurement
	./configure \
		--prefix=/usr \
		--libdir=/usr/lib/modsecurity \
		--includedir=/usr/include/modsecurity \
		--disable-apache2-module \
		--enable-pcre-study \
		--enable-pcre-jit \
		--enable-lua-cache \
		--enable-performance-measurement
	make
	make -C standalone
	make -C alp2
	make -C ext
	make -C apache2
}

package() {
	cd "$_builddir"
	install -d -m0755 "$pkgdir"/usr/lib/modsecurity
	install -d -m0755 "$pkgdir"/usr/lib/modsecurity/ext
	install -d -m0755 "$pkgdir"/usr/include/modsecurity
	make DESTDIR="$pkgdir" install

	# Standalone module
	install -Dm755 standalone/.libs/*.a "$pkgdir"/usr/lib/modsecurity
	install -Dm755 standalone/.libs/*.so "$pkgdir"/usr/lib/modsecurity
	install -Dm644 standalone/*.h "$pkgdir"/usr/include/modsecurity

	# Audit Log Parser libs
	install -Dm755 alp2/.libs/*.a "$pkgdir"/usr/lib/modsecurity
	install -Dm755 alp2/.libs/*.so "$pkgdir"/usr/lib/modsecurity
	install -Dm644 alp2/*.h "$pkgdir"/usr/include/modsecurity

	# Apache modules
	install -d -m0755 "$pkgdir"/usr/lib/modsecurity/ext/apache2
	install -Dm755 apache2/.libs/*.so "$pkgdir"/usr/lib/modsecurity/ext/apache2
	install -Dm755 ext/.libs/*.so "$pkgdir"/usr/lib/modsecurity/ext/apache2

	# Nginx module
	install -d -m0755 "$pkgdir"/usr/lib/modsecurity/ext/nginx
	install -Dm644 nginx/modsecurity/ngx_http_modsecurity.c "$pkgdir"/usr/lib/modsecurity/ext/nginx
	install -Dm644 "$srcdir"/nginx.buildconfig "$pkgdir"/usr/lib/modsecurity/ext/nginx/config
	install -Dm644 apache2/*.h "$pkgdir"/usr/include/modsecurity
	install -Dm644 /usr/include/httpd/*.h "$pkgdir"/usr/include/modsecurity

	# Miscellaneous and documentation
	install -Dm644 mlogc/mlogc-default.conf "$pkgdir"/etc/modsecurity/mlogc.conf
	install -Dm644 tools/rules-updater-example.conf "$pkgdir"/etc/modsecurity/update.conf
	install -Dm644 modsecurity.conf-recommended "$pkgdir"/etc/modsecurity/modsecurity.conf
	install -Dm644 mlogc/INSTALL "$pkgdir"/usr/share/doc/modsecurity/mlogc.txt
	install -Dm644 ext/README "$pkgdir"/usr/share/doc/modsecurity/extensions.txt
	install -Dm644 doc/README.txt "$pkgdir"/usr/share/doc/modsecurity/doc.txt
	install -Dm644 README.TXT "$pkgdir"/usr/share/doc/modsecurity/README.txt

	# Core Ruleset
	cd "$pkgdir"/etc/modsecurity
	msg "Retrieving current ModSecurity core ruleset"
	if [[ -d $_gitbase ]]; then
		cd $_gitbase && git pull origin
		msg "Local copy updated"
	else
		git clone $_gitrepo $_gitbase
		msg "Repository cloned"
	fi
}
