# Maintainer: count-corrupt <corrupt at giggedy dot de>
pkgname=rr231x_0x
pkgver=2.5
pkgrel=1
pkgdesc="Kernel modules for Highpoint RocketRAID 230x and 231x SATA cards. Patched for use with kernel26 =2.6.37 and >=2.6.38"
arch=('i686' 'x86_64')
url="http://www.highpoint-tech.com/USA/bios_rr2310.htm"
license=('custom')
groups=()
depends=('kernel26')
makedepends=('kernel26-headers')
provides=()
conflicts=()
replaces=()
backup=()
options=()
install=$pkgname.install
source=(http://www.support-highpoint-tech.com/Main/rr231x_00/Linux/opensrc/$pkgname-linux-src-v$pkgver-091022-1618.tar.gz scsi_lck.patch)
noextract=()
md5sums=('59ce7354ed06f780584fed124c57c222' 'aab69de268d55cba45520403c675c0fe')

#_kernver=2.6.39-ARCH
_kernver=`uname -r`

build() {
    mkdir -p $startdir/pkg/lib/modules/${_kernver}/kernel/drivers/scsi/

    # Apply the scsi lock patch to make the driver work with kernel26 > 2.6.37
    cd $startdir
    patch -p0 -i $startdir/scsi_lck.patch

    cd $startdir/src/rr231x_0x-linux-src-v$pkgver/product/rr2310pm/linux/
    make KERNELDIR=/usr/src/linux-$_kernver || return 1

    # Install the kernel module
    install -m 644 -D rr2310_00.ko $startdir/pkg/lib/modules/${_kernver}/kernel/drivers/scsi/

    mkdir -p $startdir/pkg/usr/share/licenses/$pkgname
    cp $startdir/src/rr231x_0x-linux-src-v$pkgver/README $startdir/pkg/usr/share/licenses/$pkgname/
}
 
