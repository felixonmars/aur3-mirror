# Maintainer: Alessandro Sagratini <ale_sagra at hotmail dot com>
pkgname=rr264x
pkgver=1.3
pkgrel=3
pkgdesc="Kernel modules for Highpoint RocketRAID 2640X1 SAS Card. Patched for use with kernel26 >=2.6.37 and kernel >= 3 (a.k.a. linux)"
arch=('i686' 'x86_64')
url="http://www.highpoint-tech.com/USA_new/series_rr2600.htm"
license=('custom')
groups=()

depends=('linux')
makedepends=('linux-headers')

provides=()
conflicts=()
replaces=()
backup=()
options=()
install=$pkgname.install
source=(http://www.highpoint-tech.cn/BIOS_Driver/rr26xx/2640X1-2640X4-2642/Linux/rr264x-linux-src-v1.3-legacy_single-101203-0910.tar.gz scsi_lck.patch kernel3.patch)
noextract=()
md5sums=('14856755232b273113f9e4f882a1a500' 'b96f51f73edf509564f02f96c3ee62be' 'd68544c85cf03f443e66a8878a031d03')
_extramodules=extramodules-3.3-ARCH
_kernver=`cat /lib/modules/${_extramodules}/version`

build() {
    mkdir -p $startdir/pkg/lib/modules/${_extramodules}/

    cd $startdir/src/rr2640-linux-src-v$pkgver-legacy_single/
    # Apply the scsi lock patch to make the driver work with kernel > 2.6.37
    patch -p0 -i $startdir/scsi_lck.patch
    patch -p0 -i $startdir/kernel3.patch
    cd product/rr2640/linuxls/
    make KERNELDIR=/usr/src/linux-$_kernver || return 1

    # Install the kernel module
    install -m 644 -D rr26xx.ko "${pkgdir}/lib/modules/${_extramodules}/"
    gzip "${pkgdir}/lib/modules/${_extramodules}/rr26xx.ko"

    mkdir -p $pkgdir/usr/share/licenses/$pkgname
    cp $srcdir/rr2640-linux-src-v$pkgver-legacy_single/README $pkgdir/usr/share/licenses/$pkgname/
}
 

