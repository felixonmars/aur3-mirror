# Contributor: Jase, moted, canuckkat
# Thanks to: in-ferno, dreeze, woogie, MajorTom

pkgname=pms
pkgver=1.60.0
pkgrel=1
pkgdesc="DLNA compliant Upnp Media Server for the PS3, written in Java."
arch=('i686' 'x86_64')
url="http://code.google.com/p/ps3mediaserver/"
license=('GPL2')
depends=('mplayer' 'ffmpeg' 'java-runtime' 'mencoder' 'libmediainfo')
makedepends=("unzip")
[ "$CARCH" = "i686" ] && \
optdepends=("vlc: For Internet video/audio")
[ "$CARCH" = "x86_64" ] && \
optdepends=("vlc: Internet video/audio support"
            "lib32-gcc-libs: tsMuxeR support"
            "lib32-glibc: tsMuxeR support")

backup=(opt/pms/PMS.conf \
        opt/pms/WEB.conf)
source=("https://ps3mediaserver.googlecode.com/files/$pkgname-generic-linux-unix-$pkgver.tgz")
build() {
  mkdir -p $pkgdir/opt/pms
  mkdir $pkgdir/opt/pms/database
  mkdir -p $pkgdir/usr/bin
  cp -r $srcdir/$pkgname-$pkgver/* $pkgdir/opt/pms/
  chmod +x $pkgdir/opt/pms/PMS.sh \
           $pkgdir/opt/pms/linux/tsMuxeR
  cp $pkgdir/opt/pms/PMS.sh $pkgdir/usr/bin/ps3mediaserver
  sed -i '2i PMS_HOME=/opt/pms\ncd $PMS_HOME' $pkgdir/usr/bin/ps3mediaserver
  touch $pkgdir/opt/pms/PMS.conf
  touch $pkgdir/opt/pms/debug.log
  chgrp users $pkgdir/opt/pms/PMS.conf \
              $pkgdir/opt/pms/WEB.conf \
              $pkgdir/opt/pms/debug.log \
              $pkgdir/opt/pms/database

  chmod g+w $pkgdir/opt/pms/PMS.conf \
            $pkgdir/opt/pms/WEB.conf \
            $pkgdir/opt/pms/debug.log \
            $pkgdir/opt/pms/database 

  unzip -q -u $srcdir/$pkgname-$pkgver/pms.jar -d pms_jar
  install -d -m 755 $pkgdir/usr/share/pixmaps
  install -D -m 644 $srcdir/pms_jar/resources/images/clients/ps3.png $pkgdir/usr/share/pixmaps/pms.png

  cat > pms.desktop << EoF
[Desktop Entry]
Version=1.0
Encoding=UTF-8
Name=PS3 Media Server
Comment=Java DLNA compliant UPnP Media Server for the PS3
Exec=ps3mediaserver
Icon=pms.png
Terminal=false
Type=Application
Categories=Java;Network;
EoF

  install -D -m 644 $srcdir/pms.desktop $pkgdir/usr/share/applications/pms.desktop

}

sha1sums=('7b4e6a901e74ef26c10fc68ddeac9b9ed1c4b884')
