# Contributor: Prurigro
# Maintainer: Prurigro

pkgname=cjdns-git
pkgver=120423
pkgrel=2
pkgdesc="A routing engine designed for security, scalability, speed and ease of use."
url="https://github.com/cjdelisle/cjdns"
license="GPLv3"
depends=('libevent' 'iproute2' 'net-tools' 'sqlite3')
makedepends=('git' 'cmake' 'make' 'gcc')
arch=('i686' 'x86_64' 'armv7h')
source=('cjdns.rc.d' 'cjdns.conf.d' 'cjdwebadmin.rc.d' 'cjdwebadmin.conf.d')
sha1sums=('0ffe6976bee108afca813be58b7947e88beefd0f'
         '03fb50ca056532c26a12e4fba13d264158cb23ca'
         'd9fbe85df17a8f0f59cbab39ee186fd36c3664c8'
         '947636991ef92bd969c66a536b351232e78a7673')
install=${pkgname}.install

#Disable Arch's default compilation optimizations
CFLAGS=""
OPTIONS=""

build() {
    #Delete cjdadmin-cli if it already exists and clone the repo
    if [ -d "$srcdir"/cjdadmin-cli ]; then rm -rf "$srcdir"/cjdadmin-cli; fi
    git clone git://github.com/prurigro/cjdadmin-cli.git

    #Delete cjdns if it already exist and clone the repo
    if [ -d "$srcdir"/cjdns ]; then rm -rf "$srcdir"/cjdns; fi
    git clone https://github.com/cjdelisle/cjdns.git

    #Remove the -O3 optimization as it causes cjdns to fail its self tests
    cat cjdns/CMakeLists.txt | sed 's/add_definitions(-O3 -funroll-loops -fomit-frame-pointer)/add_definitions(-funroll-loops -fomit-frame-pointer)/' > CMakeLists.txt
    mv CMakeLists.txt cjdns/CMakeLists.txt

    #Build the cjdns suite
    install -d "$srcdir"/cjdns/build
    pushd "$srcdir"/cjdns/build
       cmake ..
       make
       #Uncomment the line below to require cjdns to pass its self-tests
       #make test 
    popd
}

package() {
    pushd "$srcdir"
        install -D -m755 cjdns.rc.d "$pkgdir"/etc/rc.d/cjdns
        install -D -m644 cjdns.conf.d "$pkgdir"/etc/conf.d/cjdns
        install -D -m755 cjdwebadmin.rc.d "$pkgdir"/etc/rc.d/cjdwebadmin
        install -D -m644 cjdwebadmin.conf.d "$pkgdir"/etc/conf.d/cjdwebadmin
        install -D -m755 cjdadmin-cli/cjdadmin "$pkgdir"/usr/bin/cjdadmin
        install -D -m755 cjdns/build/cjdroute "$pkgdir"/usr/bin/cjdroute
        install -D -m755 cjdns/build/contrib/http/HttpServer "$pkgdir"/usr/bin/cjdwebadmin
        install -d "$pkgdir"/usr/share/cjdns/cjdwebadmin
        cp -R cjdns/contrib/http/text "$pkgdir"/usr/share/cjdns/cjdwebadmin/
    popd
}
