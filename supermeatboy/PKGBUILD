# Maintainer: zendeavor <j.s.mcgee115@gmail.com>
# Contributor: Daniel Wallace <danielwallace at gtmanfred dot com>
# Contributor: Yochai Gal <yochaigal@gmail.com>
# Contributor: Yann Kaiser <kaiser.yann@gmail.com>

pkgname=supermeatboy
pkgver=20120607
_pkgver=06072012
pkgrel=9
pkgdesc="Super Meat Boy is a game where you play as a boy without skin whose girlfriend who is made of bandages gets kidnapped by a fetus in a tuxedo wearing a top hat and a monocle."
url="http://www.supermeatboy.com/"
license=('custom')
arch=('i686' 'x86_64')
groups=("humble-indie-bundleV" "humble-indie-bundle4" "games")
depends=('openal' 'sdl')
makedepends=('unzip' 'curl')
source=("${pkgname}-linux-${_pkgver}-bin" 
        "${pkgname}.install"
        "${pkgname}.desktop"
        "${pkgname}.sh")
md5sums=("90a563ff103b4610b41af5fd2bccb21a"
        "b25345577b44fbeeba96c6cc87f11c1e"
        "ceda8cdca2aaff63a9cae2ef7d7cf0d4"
        "c59565efc66ed594b40da786c7c58609")
PKGEXT=".pkg.tar"

_humblebundle() {
  _archive="source[0]%%:*"
  for group in "${groups[@]}"; do
              
    [[ -f "${!_archive}" ]] && break

    case "${group}" in 
      "humble-indie-bundle"*) _key="_humblebundle${group:19}key" ;;
      *) continue ;;
    esac

  if [[ -n "${!_key}" ]]; then
    _uri="$(curl -s http://www.humblebundle.com/downloads?key="${!_key}" \
      | grep "${!_archive}")"
    echo "Choose download method."
    echo "1. Torrent with aria2c"
    echo "2. HTTP with curl"
    read -a _method
    if [[ "${_method}" -eq 2 ]]; then
      _uri="${_uri##*data-web\=\'}"
      _uri="${_uri%%\'*}" 
      curl -o "${!_archive}" "${_uri}"
    else
      _uri="${_uri##*data-bt\=\'}"
      _uri="${_uri%%\'*}" 
      echo "To resume this download later:"
      echo "Run \`aria2c ${pkgname}.torrent\`"
      [[ ! -f "${pkgname}.torrent" ]] &&
        curl -o "${pkgname}.torrent" "${_uri}"
      aria2c "${pkgname}.torrent" --seed-time=0
    fi
    source[0]="${!_archive}::${_uri}"
    break
  else
    warning "Please export _humblebundle4key or _humblebundleVkey for downloading"
    echo "Alternatively, place the download into ${startdir} and retry"
  fi

  done

  if [[ -z "${!_key}" && -f "${startdir}/${_archive}" ]]; then
    error "Failed to download \"${!_archive}\"."
    exit 1
  fi
  unset _archive _key _uri 
}

package() {
  mkdir -p "${pkgdir}/opt/${pkgname}"
  unzip -u "${source[0]%%:*}" -d "${pkgdir}/opt/${pkgname}" || true
  find "${pkgdir}" -type f -exec chmod 644 "{}" +
  install -Dm644 "${pkgname}".desktop "${pkgdir}/usr/share/applications/${pkgname}.desktop"
  install -Dm755 "${pkgname}".sh "${pkgdir}/usr/bin/${pkgname}"
  chmod 755 "${pkgdir}/opt/${pkgname}/data/SuperMeatBoy" \
    "${pkgdir}/opt/${pkgname}/data/amd64/SuperMeatBoy-amd64" \
    "${pkgdir}/opt/${pkgname}/data/x86/SuperMeatBoy-x86"
}

_humblebundle

# vim: ft=PKGBUILD sts=2 ts=2 sw=2 et

