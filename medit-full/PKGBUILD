# Contributor: Connor Behan <connor.behan@gmail.com>

pkgname=medit-full
pkgver=0.10.5
pkgrel=2
pkgdesc="Medit with the python bindings restored"
arch=('i686' 'x86_64')
url="http://mooedit.sourceforge.net"
options=('!emptydirs')
license=('GPL')
depends=('pygtk' 'libxml2' 'pcre' 'libsm' 'python2' 'gtk2' 'gcc-libs')
makedepends=('cmake' 'pkgconfig' 'perlxml' 'intltool' 'gcc-objc')
conflicts=('medit')
replaces=('medit')
provides=('medit')
install=medit.install
source=(http://downloads.sourceforge.net/mooedit/medit-${pkgver}.tar.bz2 bindings2.diff capsule.diff)

build() {
  cd $srcdir/medit-${pkgver}
  # Fixes the bug that comes from the pygtk patch
  patch -Np1 -i $srcdir/capsule.diff || return 1

  # This is a huge hack but I don't know how to make cmake treat static libraries as sources
  patch -Np1 -i $srcdir/bindings2.diff || return 1
  
  # These files are autogenerated during the build but cmake will complain if they don't exist initially
  touch plugins/moopython/pygtk/mooapp-pygtk.c
  touch plugins/moopython/pygtk/mooedit-pygtk.c
  touch plugins/moopython/pygtk/mooutils-pygtk.c

  cmake . -DCMAKE_INSTALL_PREFIX=/usr -DCMAKE_BUILD_TYPE=Release -DMOO_ENABLE_PYTHON=ON -DMOO_DEV_MODE_CMAKE=ON
  make || return 1
  make DESTDIR=$startdir/pkg install || return 1
  
  cd $pkgdir/usr/share/moo/language-specs
  sed -i "s|*.sh|*.sh;PKGBUILD|" sh.lang

  rm -rf $startdir/pkg/usr/share/mime && \
  rm -rf $startdir/pkg/usr/share/icons/hicolor/icon-theme.cache
  mv $pkgdir/usr/lib/python2.7/site-packages/libmoomod.so $pkgdir/usr/lib/python2.7/site-packages/moo.so
}
md5sums=('fcbb40efbe1275648a8b62e944354a00' '9f6b8fb0270f5c7b3f6102b09c6f7774' '0a35030a27674454d20db77555735037')
