# Maintainer: Brad

pkgbase="linux-fedora"
 pkgname=linux-fedora       # Build kernel with a different name
_kernelname=${pkgname#linux}
_basekernel=3.3.5
pkgver=${_basekernel}
pkgrel=1
makedepends=('xmlto' 'docbook-xsl')
arch=(i686 x86_64)
license=('GPL2')
url="http://www.kernel.org"
options=(!strip)
source=(ftp://ftp.kernel.org/pub/linux/kernel/v3.x/linux-${pkgver}.tar.xz
        # the main kernel config files
        config-i386 config.x86_64
        # standard config files for mkinitcpio ramdisk
        linux-fedora.preset
	acpi-sony-nonvs-blacklist.patch
	arm-smsc-support-reading-mac-address-from-device-tree.patch
	arm-tegra-nvec-kconfig.patch
	die-floppy-die.patch
	disable-i8042-check-on-apple-mac.patch
	disable-threading-in-compression-for-hibernate.patch
	dmar-disable-when-ricoh-multifunction.patch
	drm-vgem.patch
	efi-dont-map-boot-services-on-32bit.patch
	ext4-fix-resize-when-resizing-within-single-group.patch
	ext4-Support-check-none-nocheck-mount-options.patch
	fix_xen_guest_on_old_EC2.patch
	floppy-Remove-_hlt-related-functions.patch
	hfsplus-Add-an-ioctl-to-bless-files.patch
	hfsplus-Change-finder_info-to-u32.patch
	hibernate-freeze-filesystems.patch
	linux-2.6.30-no-pcspkr-modalias.patch
	linux-2.6-32bit-mmap-exec-randomization.patch
	linux-2.6-acpi-debug-infinite-loop.patch
	linux-2.6-acpi-video-dos.patch
	linux-2.6-defaults-acpi-video.patch
	linux-2.6-defaults-aspm.patch
	linux-2.6-e1000-ich9-montevina.patch
	linux-2.6-i386-nx-emulation.patch
	linux-2.6-input-kill-stupid-messages.patch
	linux-2.6-intel-iommu-igfx.patch
	linux-2.6-serial-460800.patch
	linux-2.6-silence-acpi-blacklist.patch
	linux-2.6-silence-fbcon-logo.patch
	linux-2.6-silence-noise.patch
	linux-3.1-keys-remove-special-keyring.patch
	linux-3.3-newidmapper-01.patch
	linux-3.3-newidmapper-02.patch
	linux-3.3-newidmapper-03.patch
	linux-3.3-virtio-scsi.patch
	lis3-improve-handling-of-null-rate.patch
	mcelog-rcu-splat.patch
	modpost-add-option-to-allow-external-modules-to-avoi.patch
	power-x86-destdir.patch
	quite-apm.patch
	rt2x00_fix_MCU_request_failures.patch
	scsi-sd_revalidate_disk-prevent-NULL-ptr-deref.patch
	sony-laptop-Enable-keyboard-backlight-by-default.patch
	taint-vbox.patch
	unhandled-irqs-switch-to-polling.patch
	utrace.patch
	x86-Avoid-invoking-RCU-when-CPU-is-idle.patch)

build() {
	cd ${srcdir}/linux-${pkgver}

	# Add  patches
	patch -Np1 -i ${srcdir}/taint-vbox.patch
	patch -Np1 -i ${srcdir}/linux-2.6-32bit-mmap-exec-randomization.patch
	patch -Np1 -i ${srcdir}/linux-2.6-i386-nx-emulation.patch

	patch -Np1 -i ${srcdir}/linux-2.6-defaults-aspm.patch

	patch -Np1 -i ${srcdir}/linux-2.6-defaults-acpi-video.patch
	patch -Np1 -i ${srcdir}/linux-2.6-acpi-video-dos.patch
	patch -Np1 -i ${srcdir}/linux-2.6-acpi-debug-infinite-loop.patch
#	patch -Np1 -i ${srcdir}/acpi-ensure-thermal-limits-match-cpu-freq.patch
	patch -Np1 -i ${srcdir}/acpi-sony-nonvs-blacklist.patch

	patch -Np1 -i ${srcdir}/linux-2.6-input-kill-stupid-messages.patch
	patch -Np1 -i ${srcdir}/linux-2.6.30-no-pcspkr-modalias.patch

	patch -Np1 -i ${srcdir}/linux-2.6-serial-460800.patch

	patch -Np1 -i ${srcdir}/die-floppy-die.patch
	patch -Np1 -i ${srcdir}/floppy-Remove-_hlt-related-functions.patch

	patch -Np1 -i ${srcdir}/linux-2.6-silence-noise.patch
	patch -Np1 -i ${srcdir}/quite-apm.patch
	patch -Np1 -i ${srcdir}/linux-2.6-silence-fbcon-logo.patch
	patch -Np1 -i ${srcdir}/modpost-add-option-to-allow-external-modules-to-avoi.patch

	patch -Np1 -i ${srcdir}/linux-2.6-e1000-ich9-montevina.patch

	# virt + ksm patches
	patch -Np1 -i ${srcdir}/fix_xen_guest_on_old_EC2.patch
	patch -Np1 -i ${srcdir}/linux-3.3-virtio-scsi.patch

	# DRM
	patch -Np1 -i ${srcdir}/drm-vgem.patch

	patch -Np1 -i ${srcdir}/linux-2.6-intel-iommu-igfx.patch

	# Quiet boot fixes
	# silence the ACPI blacklist code
	patch -Np1 -i ${srcdir}/linux-2.6-silence-acpi-blacklist.patch

	# fs fixes
	patch -Np1 -i ${srcdir}/ext4-fix-resize-when-resizing-within-single-group.patch

	# NFSv4
	patch -Np1 -i ${srcdir}/linux-3.1-keys-remove-special-keyring.patch
	patch -Np1 -i ${srcdir}/linux-3.3-newidmapper-01.patch
	patch -Np1 -i ${srcdir}/linux-3.3-newidmapper-02.patch
	patch -Np1 -i ${srcdir}/linux-3.3-newidmapper-03.patch

	# patches headed upstream
	patch -Np1 -i ${srcdir}/disable-i8042-check-on-apple-mac.patch

	patch -Np1 -i ${srcdir}/dmar-disable-when-ricoh-multifunction.patch

	patch -Np1 -i ${srcdir}/efi-dont-map-boot-services-on-32bit.patch

	patch -Np1 -i ${srcdir}/hibernate-freeze-filesystems.patch

	patch -Np1 -i ${srcdir}/lis3-improve-handling-of-null-rate.patch

	patch -Np1 -i ${srcdir}/utrace.patch

	# Flattened devicetree support
	patch -Np1 -i ${srcdir}/arm-smsc-support-reading-mac-address-from-device-tree.patch
	patch -Np1 -i ${srcdir}/arm-tegra-nvec-kconfig.patch

	patch -Np1 -i ${srcdir}/ext4-Support-check-none-nocheck-mount-options.patch

#	patch -Np1 -i ${srcdir}/udlfb-remove-sysfs-framebuffer-device-with-USB-disconnect.patch

	patch -Np1 -i ${srcdir}/rt2x00_fix_MCU_request_failures.patch

	patch -Np1 -i ${srcdir}/power-x86-destdir.patch

	patch -Np1 -i ${srcdir}/hfsplus-Change-finder_info-to-u32.patch
	patch -Np1 -i ${srcdir}/hfsplus-Add-an-ioctl-to-bless-files.patch

	#rhbz 788260
#	patch -Np1 -i ${srcdir}/jbd2-clear-BH_Delay-and-BH_Unwritten-in-journal_unmap_buf.patch

	#rhbz 754518
	patch -Np1 -i ${srcdir}/scsi-sd_revalidate_disk-prevent-NULL-ptr-deref.patch

	patch -Np1 -i ${srcdir}/mcelog-rcu-splat.patch
	patch -Np1 -i ${srcdir}/x86-Avoid-invoking-RCU-when-CPU-is-idle.patch

	#rhbz 795544
#	patch -Np1 -i ${srcdir}/ums_realtek-do-not-use-stack-memory-for-DMA-in-__do_.patch

	#rhbz 727865 730007
#	patch -Np1 -i ${srcdir}/ACPICA-Fix-regression-in-FADT-revision-checks.patch

	#rhbz 728478
	patch -Np1 -i ${srcdir}/sony-laptop-Enable-keyboard-backlight-by-default.patch

	# Disable threading in hibernate compression
	patch -Np1 -i ${srcdir}/disable-threading-in-compression-for-hibernate.patch

	patch -Np1 -i ${srcdir}/unhandled-irqs-switch-to-polling.patch

	echo "patching ...done"

	if [ "$CARCH" = "x86_64" ]; then
    		cat ../config.x86_64 >./.config
  	else
    		cat ../config >./.config
  	fi
  	if [ "${_kernelname}" != "" ]; then
    		sed -i "s|CONFIG_LOCALVERSION=.*|CONFIG_LOCALVERSION=\"${_kernelname}\"|g" ./.config
  	fi

  	make prepare
 
  	yes "" | make config

  	make ${MAKEFLAGS} bzImage modules
}

package() {
	pkgdesc="The Linux Kernel plus Fedora patches, modules and headers with debug enabled for systemtap"
	groups=('base')
  	provides=("linux-fedora=${pkgver}")
  	conflicts=('kernel26-fedora' 'linux-fedora')
  	replaces=('kernel26-fedora' 'linux-fedora')
  	backup=(etc/mkinitcpio.d/linux-fedora.preset)
  	depends=('coreutils' 'linux-firmware' 'module-init-tools>=3.16' 'mkinitcpio>=0.7')
	  
  	replaces=('kernel24' 'kernel24-scsi' 'kernel26-scsi'
            'alsa-driver' 'ieee80211' 'hostap-driver26'
            'pwc' 'nforce' 'squashfs' 'unionfs' 'ivtv'
            'zd1211' 'kvm-modules' 'iwlwifi' 'rt2x00-cvs'
            'gspcav1' 'atl2' 'wlan-ng26' 'rt2500' 'nouveau-drm')
  	install=linux.install
  	optdepends=('crda: to set the correct wireless channels of your country')

  	KARCH=x86
  	cd ${srcdir}/linux-${pkgver}
  	# get kernel version
  	_kernver="$(make kernelrelease)"
  	mkdir -p ${pkgdir}/{lib/modules,lib/firmware,boot}
  	make INSTALL_MOD_PATH=${pkgdir} modules_install
  	cp System.map ${pkgdir}/boot/System.map${_kernelname}
  	cp arch/$KARCH/boot/bzImage ${pkgdir}/boot/vmlinuz${_kernelname}
  	#  # add vmlinux
  	install -m644 -D vmlinux ${pkgdir}/usr/src/linux-${_kernver}/vmlinux

  	# install fallback mkinitcpio.conf file and preset file for kernel
  	install -m644 -D ${srcdir}/linux-fedora.preset ${pkgdir}/etc/mkinitcpio.d/${pkgname}.preset
  	# set correct depmod command for install
  	sed \
    		-e  "s/KERNEL_NAME=.*/KERNEL_NAME=${_kernelname}/g" \
    		-e  "s/KERNEL_VERSION=.*/KERNEL_VERSION=${_kernver}/g" \
    		-i $startdir/linux.install
  	sed \
    		-e "s|source .*|source /etc/mkinitcpio.d/linux${_kernelname}.kver|g" \
    		-e "s|default_image=.*|default_image=\"/boot/${pkgname}.img\"|g" \
    		-e "s|fallback_image=.*|fallback_image=\"/boot/${pkgname}-fallback.img\"|g" \
    		-i ${pkgdir}/etc/mkinitcpio.d/${pkgname}.preset

  	echo -e "# DO NOT EDIT THIS FILE\nALL_kver='${_kernver}'" > ${pkgdir}/etc/mkinitcpio.d/${pkgname}.kver
  	# remove the firmware
  	rm -rf ${pkgdir}/lib/firmware
  	# gzip -9 all modules to safe 100MB of space
  	find "$pkgdir" -name '*.ko' -exec gzip -9 {} \;

  	# Add the headers package
  	mkdir -p ${pkgdir}/lib/modules/${_kernver}
  	cd ${pkgdir}/lib/modules/${_kernver}
	#  ln -sf /usr/src/linux-${_kernver} build
	#  ln -sf ../../../usr/src/linux-${_kernver} build
  	cd ${srcdir}/linux-${pkgver}
  	install -D -m644 Makefile \
    		${pkgdir}/usr/src/linux-${_kernver}/Makefile
  	install -D -m644 kernel/Makefile \
    		${pkgdir}/usr/src/linux-${_kernver}/kernel/Makefile
  	install -D -m644 .config \
    		${pkgdir}/usr/src/linux-${_kernver}/.config
  	mkdir -p ${pkgdir}/usr/src/linux-${_kernver}/include

  	cp -R include/* ${pkgdir}/usr/src/linux-${_kernver}/include/.

  	# copy arch includes for external modules
  	mkdir -p ${pkgdir}/usr/src/linux-${_kernver}/arch/x86
  	cp -a arch/x86/include ${pkgdir}/usr/src/linux-${_kernver}/arch/x86/

  	# copy files necessary for later builds, like nvidia and vmware
  	cp Module.symvers ${pkgdir}/usr/src/linux-${_kernver}
  	cp -a scripts ${pkgdir}/usr/src/linux-${_kernver}
  	# fix permissions on scripts dir
  	chmod og-w -R ${pkgdir}/usr/src/linux-${_kernver}/scripts
  	mkdir -p ${pkgdir}/usr/src/linux-${_kernver}/.tmp_versions

  	mkdir -p ${pkgdir}/usr/src/linux-${_kernver}/arch/$KARCH/kernel

  	cp arch/$KARCH/Makefile ${pkgdir}/usr/src/linux-${_kernver}/arch/$KARCH/
  	if [ "$CARCH" = "i686" ]; then
		cp arch/$KARCH/Makefile_32.cpu ${pkgdir}/usr/src/linux-${_kernver}/arch/$KARCH/
  	fi
  	cp arch/$KARCH/kernel/asm-offsets.s ${pkgdir}/usr/src/linux-${_kernver}/arch/$KARCH/kernel/

  	# add headers for lirc package
  	mkdir -p ${pkgdir}/usr/src/linux-${_kernver}/drivers/media/video
  	cp drivers/media/video/*.h  ${pkgdir}/usr/src/linux-${_kernver}/drivers/media/video/
  	for i in bt8xx cpia2 cx25840 cx88 em28xx et61x251 pwc saa7134 sn9c102; do
   		mkdir -p ${pkgdir}/usr/src/linux-${_kernver}/drivers/media/video/$i
   		cp -a drivers/media/video/$i/*.h ${pkgdir}/usr/src/linux-${_kernver}/drivers/media/video/$i
  	done

  	install -D -m644 Documentation/DocBook/Makefile \
    		${pkgdir}/usr/src/linux-${_kernver}/Documentation/DocBook/Makefile

  	mkdir -p ${pkgdir}/usr/src/linux-${_kernver}/drivers/md
  	cp drivers/md/*.h  ${pkgdir}/usr/src/linux-${_kernver}/drivers/md

  	mkdir -p ${pkgdir}/usr/src/linux-${_kernver}/include/linux
  	cp include/linux/inotify.h ${pkgdir}/usr/src/linux-${_kernver}/include/linux/

  	mkdir -p ${pkgdir}/usr/src/linux-${_kernver}/net/mac80211/
  	cp net/mac80211/*.h ${pkgdir}/usr/src/linux-${_kernver}/net/mac80211/
  	mkdir -p ${pkgdir}/usr/src/linux-${_kernver}/drivers/media/dvb/dvb-core
  	cp drivers/media/dvb/dvb-core/*.h ${pkgdir}/usr/src/linux-${_kernver}/drivers/media/dvb/dvb-core/

  	mkdir -p ${pkgdir}/usr/src/linux-${_kernver}/include/config/dvb/
  	cp include/config/dvb/*.h ${pkgdir}/usr/src/linux-${_kernver}/include/config/dvb/

  	mkdir -p ${pkgdir}/usr/src/linux-${_kernver}/drivers/media/dvb/frontends/
  	cp drivers/media/dvb/frontends/lgdt330x.h ${pkgdir}/usr/src/linux-${_kernver}/drivers/media/dvb/frontends/
  	cp drivers/media/video/msp3400-driver.h ${pkgdir}/usr/src/linux-${_kernver}/drivers/media/dvb/frontends/

  	mkdir -p ${pkgdir}/usr/src/linux-${_kernver}/drivers/media/dvb/dvb-usb
  	cp drivers/media/dvb/dvb-usb/*.h ${pkgdir}/usr/src/linux-${_kernver}/drivers/media/dvb/dvb-usb/
  	mkdir -p ${pkgdir}/usr/src/linux-${_kernver}/drivers/media/dvb/frontends
  	cp drivers/media/dvb/frontends/*.h ${pkgdir}/usr/src/linux-${_kernver}/drivers/media/dvb/frontends/
  	mkdir -p ${pkgdir}/usr/src/linux-${_kernver}/drivers/media/common/tuners
  	cp drivers/media/common/tuners/*.h ${pkgdir}/usr/src/linux-${_kernver}/drivers/media/common/tuners/

  	mkdir -p ${pkgdir}/usr/src/linux-${_kernver}/fs/xfs
  	mkdir -p ${pkgdir}/usr/src/linux-${_kernver}/mm
  	cp fs/xfs/xfs_sb.h ${pkgdir}/usr/src/linux-${_kernver}/fs/xfs/xfs_sb.h

  	for i in `find . -name "Kconfig*"`; do 
    		mkdir -p ${pkgdir}/usr/src/linux-${_kernver}/`echo $i | sed 's|/Kconfig.*||'`
    		cp $i ${pkgdir}/usr/src/linux-${_kernver}/$i
  	done

  	chown -R root.root ${pkgdir}/usr/src/linux-${_kernver}
  	find ${pkgdir}/usr/src/linux-${_kernver} -type d -exec chmod 755 {} \;

  	find ${pkgdir}/usr/src/linux-${_kernver}/scripts  -type f -perm -u+w 2>/dev/null | while read binary ; do
		case "$(file -bi "$binary")" in
	    		*application/x-sharedlib*) # Libraries (.so)
	    		/usr/bin/strip $STRIP_SHARED "$binary";;
	    		*application/x-archive*) # Libraries (.a)
	    		/usr/bin/strip $STRIP_STATIC "$binary";;
	    		*application/x-executable*) # Binaries
	    		/usr/bin/strip $STRIP_BINARIES "$binary";;
	    	esac 
  	done 
  	# remove unneeded architectures
  rm -rf ${pkgdir}/usr/src/linux-${_kernver}/arch/{alpha,arm,arm26,avr32,blackfin,cris,frv,h8300,ia64,m32r,m68k,m68knommu,mips,microblaze,mn10300,parisc,powerpc,ppc,s390,sh,sh64,sparc,sparc64,um,v850,xtensa}
}


md5sums=('065000a7302f9663830a245ac8f17f1e'
         '3047e7326ec52a678b8af911c13d0a17'
         '6f50953315aa848905d051c64b5b7862'
         '4a53bf996d106109507451109a5ad2d0'
         '9e4cfb6d73efde3c891882aa2209d26f'
         '945595e62cfb645eb9b871bd0aac1b90'
         '28c8b2f9aaadda71b429a6198bf540be'
         '0d5ef2e9201c71ed8f4ff85a981b93dc'
         'b5541dd0d354884dd1ff79d7ad7661f4'
         'a5bb99c0447f8c642a4aca57e7e64b16'
         '93e63afd37c2726d14acce2727d84f17'
         '783444382310bdf5ed3a3a4a5152c5e6'
         'c0cd97255f54e2f6ecf96f53f8cfdfe6'
         '9f1c4911e1d28b57990f589dab17fccc'
         '311fc98e3274a3966dbe96889984342a'
         '65f3d623fd0c55bc8d2b90c5083940cb'
         '3a986312d06246adce0df172543e0c42'
         'e0d7e82c67abf19008ebc3065869e825'
         'c3aa53745984103df4f6f3694d559476'
         '00130e998078e9bfe92b0218d108d5de'
         'd0bb7577944432e6f98bb53615da8b34'
         'ed5a162f25836676f1ebd088d3d1044c'
         '29d0aa1d221d842b6a57bf65db411e05'
         '96bd5bb046edb6de1f713e72fe8c6346'
         'f8d6c746bf81f54ee73e2879c2e0a035'
         'e7b0133bfd9cd2bdf4ca3c231585ea73'
         '8f9f3da3e4bf88cbac9bf6e27c07dd6d'
         '4d5ae005f5526c17ed40ae33c8f08a0f'
         '10b7b35635f787cb5596aed2206c9187'
         '0634d24b8175ecd7b0dec6a0c2f28429'
         '71e35228aebdcc7e7cadd7215972da2a'
         '529a3da98d3fd021c6fb949301c98eee'
         '13fa4b7b4f5cfaba0c39f3780b3835d0'
         '5d1ccda093c0496bb329e3315b113351'
         'd13224e2479422aab98673e3cc47654f'
         '8967b00afa609573cc407b2af52a5bc1'
         'db231acfe1c9c383afb3c8bf46efd4c1'
         'd3fbe68ca4abd2c7c5068593b27c8c5d'
         '25d5b4e1df28075881571627ba7f40b7'
         '372f29988424c626f9d21ef1b11ae035'
         '68f96cd6b79ddd0c1cd01ea2b9f1fe84'
         'b02ec45b1c752d7ede3f6c65e2878f14'
         '2c784c3385c4e48a4454db84a4b4613c'
         '30b3c640c7375f43ee7f2ad5ff2c9b6d'
         '998b6a97b4f847468a289b2d58eceeae'
         'ec811be83a56734ae01fa5fd91fb29c3'
         '6b2125c9f6b013724cc42f473920ec05'
         '822ee1704afed349368eeb000a7e266b'
         'c5bdf57cf0109ce3dbd9b23b37c4b4f3'
         '65ee4ece12c60c3ce447b9c7f7468140'
         'd5fc62ac01b067eb25c873c1d5ef8793')
