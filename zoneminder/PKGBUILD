# Maintainer: Troy Will <troydwill@gmail.com>
pkgname=zoneminder
pkgver=1.28.0
pkgrel=5
pkgdesc='Capture, analyse, record and monitor video security cameras'
arch=( i686 x86_64 mips64el arm )
     
backup=( etc/zm.conf )
url="https://github.com/ZoneMinder/ZoneMinder/releases"
license=( GPL )
     
depends=(
    apache
    cambozola
    gnutls
    mariadb
    perl-archive-zip
    perl-date-manip
    perl-dbd-mysql
    perl-dbi
    perl-expect
    perl-libwww
    perl-mime-lite
    perl-mime-tools
    perl-php-serialization
    perl-net-sftp-foreign
    perl-sys-mmap
    perl-time-modules
    perl-x10
    php
    php-apache
    php-gd
    php-mcrypt
    polkit
)

makedepends=(
    netpbm
    cmake
)

optdepends=(
    netpbm
)
     
install=$pkgname.install
     
source=(
    https://github.com/ZoneMinder/ZoneMinder/archive/v$pkgver.tar.gz
    httpd-zoneminder.conf
    zoneminder.service
)

sha512sums=('ac2a036adac436d76db8bb0b161d063111cc7cc7f6bcb9ca1b46862cfb0285b291926df716df645c0be47b7465bbbf3b1050c85529ff5068bdcc34f1c8ba6df1'
            'fb9bf263c37fae30d775872a33cb319f2f2a7a4f38faff8c143253dbefd7278b295d0805e11ace6423a8ec2b50ef60f3426b6e6a53548c867ef7f109baa52c36'
            '9d8d21022b224f833492221e6a3e7c8f0bf2272641c37440506d3fccb3995d18121e8725908345cd110513c6226cd60d100daf479953dcc0db12b8c8991c93c5')
     
build() {
    cd $srcdir/ZoneMinder-$pkgver

    cmake -DCMAKE_INSTALL_PREFIX=/usr \
        -DZM_CGIDIR=/srv/http/cgi-bin \
        -DZM_WEBDIR=/srv/http/zoneminder \
        -DZM_WEB_USER=http \
        -DZM_CONTENTDIR=/var/cache/zoneminder \
        -DZM_LOGDIR=/var/log/zoneminder \
        -DZM_RUNDIR=/srv/zoneminder \
        -DZM_TMPDIR=/srv/zoneminder/tmp \
        -DZM_SOCKDIR=/srv/zoneminder/socks .
    
    make V=0
}
     
package() {

    cd $srcdir/ZoneMinder-$pkgver

    DESTDIR=$pkgdir make install

    # BEGIN CREATE_ZONEMINDER_DIRECTORIES
    mkdir -pv           $pkgdir/var/{cache/$pkgname,log/$pkgname}
    chown -Rv http.http $pkgdir/var/{cache/$pkgname,log/$pkgname}
    
    mkdir -pv          $pkgdir/srv/zoneminder/socks
    chown -v http.http $pkgdir/srv/zoneminder/socks
    
    mkdir -pv          $pkgdir/srv/zoneminder/tmp
    chown -v http.http $pkgdir/srv/zoneminder/tmp
    
    chown -v  http.http $pkgdir/etc/zm.conf 
    chmod 0700          $pkgdir/etc/zm.conf
    # END CREATE_ZONEMINDER_DIRECTORIES

    # Make content directories in /var/cache/zoneminder and to link them in /srv/http/zoneminder
    for i in events images temp; do
        mkdir $pkgdir/var/cache/$pkgname/$i
        chown -v    http.http                $pkgdir/var/cache/$pkgname/$i
        ln -s /var/cache/$pkgname/$i         $pkgdir/srv/http/$pkgname/$i
        chown -v --no-dereference http.http  $pkgdir/srv/http/$pkgname/$i
    done

    # Create a link to the Zoneminder cgi binaries
    ln -sv /srv/http/cgi-bin $pkgdir/srv/http/$pkgname

    chown -h http.http $pkgdir/srv/http/{cgi-bin,$pkgname,$pkgname/cgi-bin}

    # Link Cambozola
    ln -s /usr/share/cambozola/cambozola.jar $pkgdir/srv/http/$pkgname

    # Install configuration files
    mkdir -p $pkgdir/etc/httpd/conf/extra
    install -D -m 644 $srcdir/httpd-$pkgname.conf $pkgdir/etc/httpd/conf/extra
    mkdir -p $pkgdir/usr/lib/systemd/system
    install -D -m 644 $srcdir/$pkgname.service    $pkgdir/usr/lib/systemd/system
    install -D -m 644 COPYING                     $pkgdir/usr/share/license/$pkgname
    install -D -m 644 db/zm*.sql                  $pkgdir/usr/share/$pkgname/db     

}
