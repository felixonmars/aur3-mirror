# Maintainer: Danilo Kuehn <dk at nogo-software dot de>
# Git: https://github.com/nogo/archlinux-pkgbuild

# Testet with this commit
# Comment this line if you want the latest and greatest version [no guarantees ;]
_shell_commit=c9f96a8f2c544eb63c8e7aca561e2ad5a6bef87e
_brackets_commit=c211ba55b186e9c627937f9e552b5443f9b2af55
# END

_shell=brackets-shell
_brackets=brackets
_cef=cef_binary_3.1547.1354_linux
_node_version=v0.8.20

if test "$CARCH" == i686; then
_cef_download=0B65Ib9j_qgvBcnB4ay11ME1KeU0
_cef_hash=c6e421b5488044c059192ad76071c84a
_node=node-${_node_version}-linux-x86
_node_hash=81346df67d76fed7c08f747082f01135
else
_cef_download=0B65Ib9j_qgvBX1NZZDRQa0oybVk
_cef_hash=d9e2d28ab87933249af9aa7b12ff11ed
_node=node-${_node_version}-linux-x64
_node_hash=03a051d0d5c1f108f3303bdfc89988ce
fi

# Package

pkgname=brackets-git
pkgver=29
pkgrel=1
pkgdesc="Adobe Brackets - An open source code editor for the web, written in JavaScript, HTML and CSS."
arch=('i686' 'x86_64')
url="http://brackets.io"
license=('MIT')
depends=('chromium' 'nodejs' 'gtkglext')
makedepends=('git' 'p7zip' 'gtk2' 'gyp-svn' 'nss' 'nspr' 'nodejs-grunt-cli')
provides=('brackets' 'adobe-brackets')
install=${pkgname}.install
conflicts=()
source=("git://github.com/adobe/brackets-shell.git"
        "git://github.com/adobe/brackets.git"
        "${_cef}.7z::https://drive.google.com/uc?export=download&id=${_cef_download}"
	"http://nodejs.org/dist/${_node_version}/${_node}.tar.gz")
md5sums=('SKIP'
         'SKIP'
	 "$_cef_hash"
         "$_node_hash")

prepare() {
  if [ ! -f /usr/lib/libnss3.so.1d ]; then
    sudo ln -s /usr/lib/libnss3.so /usr/lib/libnss3.so.1d
  fi
  if [ ! -f /usr/lib/libnssutil3.so.1d ]; then
    sudo ln -s /usr/lib/libnssutil3.so /usr/lib/libnssutil3.so.1d
  fi
  if [ ! -f /usr/lib/libnspr4.so.0d ]; then
    sudo ln -s /usr/lib/libnspr4.so /usr/lib/libnspr4.so.0d
  fi
  if [ ! -f /usr/lib/libplc4.so.0d ]; then
    sudo ln -s /usr/lib/libplc4.so /usr/lib/libplc4.so.0d
  fi
  if [ ! -f /usr/lib/libsmime3.so.1d ]; then
    sudo ln -s /usr/lib/libsmime3.so /usr/lib/libsmime3.so.1d
  fi
  if [ ! -f /usr/lib/libudev.so.0 ]; then
    sudo ln -s /usr/lib/libudev.so /usr/lib/libudev.so.0
  fi

  cd ${srcdir}/${_shell}
  if [ -n "${_shell_commit}" ]; then
    git checkout ${_shell_commit}
  fi

  cd ${srcdir}/${_brackets}
  if [ -n "${_brackets_commit}" ]; then
    git checkout ${_brackets_commit}
  fi
  git submodule update --init --recursive
}

build() {
  cd ${srcdir}/${_shell}

  mkdir deps
  cp -R ${srcdir}/${_cef} ${srcdir}/${_shell}/deps/cef
  cp -R ${srcdir}/${_node} ${srcdir}/${_shell}/deps/node
  
  rm -f Debug include libcef_dll Release Resources tools
  ln -fs deps/cef/include/ include
  ln -fs deps/cef/libcef_dll/ libcef_dll
  ln -fs deps/cef/Release/ Release
  ln -fs deps/cef/Resources/ Resources
  cp appshell.gyp.txt appshell.gyp
  gyp --depth .
  make
  
  # FIXME somehow I cannot install without sudo
  echo "sudo npm install --no-bin-links"
  sudo npm install --no-bin-links
  grunt copy:linux copy:www copy:samples
}

package() {
  mkdir -p ${pkgdir}/usr/bin
  mkdir -p ${pkgdir}/usr/lib

  cp -R ${srcdir}/${_shell}/installer/linux/debian/usr/lib/brackets ${pkgdir}/usr/lib/brackets
  chmod 0755 ${pkgdir}/usr/lib/brackets/Brackets
  cp -R ${srcdir}/${_shell}/installer/linux/debian/usr/share ${pkgdir}/usr/share

  mkdir -p ${pkgdir}/usr/lib/brackets/dev
  cp -R ${srcdir}/${_brackets}/* ${pkgdir}/usr/lib/brackets/dev/

  ln -s /usr/lib/brackets/Brackets "$pkgdir/usr/bin/brackets"

  if [ ! -f "/usr/bin/google-chrome" ]; then
    ln -s /usr/bin/chromium "$pkgdir/usr/bin/google-chrome"
  fi
}

