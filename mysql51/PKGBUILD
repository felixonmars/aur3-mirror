# Contributor: Andrea Scarpino <andrea@archlinux.org>
# Contributor: Douglas Soares de Andrade <douglas@archlinux.org>
# Contributor: judd <jvinet@zeroflux.org>
# Contributor: Danny Navarro <j@dannynavarro.net>

pkgname=mysql51
pkgver=5.1.61
pkgrel=1
arch=('i686' 'x86_64')
license=('GPL')
pkgdesc="A fast SQL database server"
backup=('etc/mysql/my.cnf')
url="http://www.mysql.com/"
depends=('openssl' 'gcc-libs')
makedepends=('zlib' 'perl' 'libtool')
optdepends=('perl-dbi' 'perl-dbd-mysql')
options=('!libtool')
provides=('mysql' 'libmysqlclient' 'mysql-clients')
conflicts=('mysql' 'libmysqlclient' 'mysql-clients')
install="${pkgname}.install"
source=("http://ftp.gwdg.de/pub/misc/mysql/Downloads/MySQL-5.1/mysql-${pkgver}.tar.gz"
        'mysqld'
        'my.cnf'
        'skip-abi-check.patch')

md5sums=('4efd10c69c4c99dbdb8fae3834a6d7b8'
         '2234207625baa29b2ff7d7b4f088abce'
         '0337741fa9afbe57939993636081a827'
         'a97e574945e19de3908575b956241026')

build() {
  cd "${srcdir}/mysql-${pkgver}"
  patch -Np0 -i "${srcdir}/skip-abi-check.patch"
  # CFLAGS/CXXFLAGS as suggested upstream
  CFLAGS="-fPIC ${CFLAGS} -fno-strict-aliasing -DBIG_JOINS=1 -fomit-frame-pointer" \
  CXXFLAGS="-fPIC ${CXXFLAGS} -fno-strict-aliasing -DBIG_JOINS=1 -felide-constructors -fno-rtti" \
  ./configure --prefix=/usr \
    --libexecdir=/usr/sbin \
    --localstatedir=/var \
    --sysconfdir=/etc/mysql \
    --without-docs \
    --with-readline \
    --without-libedit \
    --with-ssl \
    --with-zlib-dir=/usr \
    --with-charset=utf8 \
    --with-collation=utf8_general_ci \
    --with-extra-charsets=complex \
    --with-embedded-server \
    --with-unix-socket-path=/var/run/mysqld/mysqld.sock \
    --enable-local-infile \
    --with-plugins=innobase,innodb_plugin \
    --datadir=/var/lib/mysql
  make
}

package() {
  cd "${srcdir}/mysql-${pkgver}"
  make DESTDIR=${pkgdir} install
  
  # create library symlinks in /usr/lib
  ln -sf mysql/libmysqlclient.so.16 ${pkgdir}/usr/lib/libmysqlclient.so.16
  ln -sf libmysqlclient.so.16 ${pkgdir}/usr/lib/libmysqlclient.so
  ln -sf libmysqlclient.so.16 ${pkgdir}/usr/lib/libmysqlclient.so.1
  ln -sf mysql/libmysqlclient_r.so.16  ${pkgdir}/usr/lib/libmysqlclient_r.so.16
  ln -sf libmysqlclient_r.so.16 ${pkgdir}/usr/lib/libmysqlclient_r.so
  ln -sf libmysqlclient_r.so.16 ${pkgdir}/usr/lib/libmysqlclient_r.so.1

  install -Dm644 ${srcdir}/my.cnf ${pkgdir}/etc/mysql/my.cnf
  install -Dm755 ${srcdir}/mysqld ${pkgdir}/etc/rc.d/mysqld

  rm -r ${pkgdir}/usr/{sql-bench,mysql-test}

  install -dm700 ${pkgdir}/var/lib/mysql
}
