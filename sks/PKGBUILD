pkgname=sks
pkgver=1.1.2
_patchver=1.1.1
pkgrel=2
arch=('i686' 'x86_64')
license=('GPL')
pkgdesc="Synchronizing OpenPGP Key Server"
depends=('glibc')
makedepends=('ocaml-cryptokit' 'db4.6')
url="https://code.google.com/p/sks-keyserver/"
install=sks.install
backup=(etc/conf.d/sks etc/sks/sksconf etc/sks/forward.exim etc/sks/forward.postfix etc/sks/mailsync etc/sks/membership etc/sks/procmail)
source=(http://sks-keyserver.googlecode.com/files/$pkgname-$pkgver.tgz
        sks.conf.d
        sks.init
        http://archive.ubuntu.com/ubuntu/pool/universe/s/sks/${pkgname}_$_patchver+dpkgv3-6.debian.tar.gz
        http://wiresphere.de/files/sks_web.tar.gz)

md5sums=('d09b73763cfc83ab08fcf72218606302'
         '04cf445e39de1446e604aca204832fc7'
         '81602c740f236f6090309dfbf1262aa9'
         '9eac82d726d62043f5db3edf701f89d7'
         '8d421d71ef3e4add73c30ba8ad7f5b25')

build() {
  cd $srcdir/$pkgname-$pkgver

  cp Makefile.local.unused Makefile.local
  sed -i -e 's#/usr/include#/usr/include/db4.6#g' Makefile.local
  sed -i -e "s#/usr/local#$pkgdir/usr#g" Makefile.local
  sed -i -e "s#/usr/share/man#$pkgdir/usr/share/man#g" Makefile.local

  patch -p1 -i ../debian/patches/500_debian_fhs.patch

  make || sleep 1

  make
  make PREFIX="$pkgdir/usr" MANDIR="$pkgdir/usr/share/man" install

  install -m755 -D $srcdir/${pkgname}.init $pkgdir/etc/rc.d/$pkgname || return 1
  install -m644 -D $srcdir/${pkgname}.conf.d $pkgdir/etc/conf.d/$pkgname || return 1

  mkdir -p $pkgdir/etc/sks $pkgdir/var/lib/sks
  cp $srcdir/debian/debcfg/* $pkgdir/etc/sks
  sed -i -e "s#/usr/lib/sendmail#/usr/sbin/sendmail#g" $pkgdir/etc/sks/sksconf

  cp -R $srcdir/www $pkgdir/var/lib/sks
}
