# Maintainer: ngoonee <ngoonee.talk@gmail.com>
# Contributor: Adam Russell <adamlr6+arch@gmail.com>
pkgname=openchange
_codename=NOMAD
pkgver=0.10
pkgrel=3
pkgdesc="Library for MAPI connectivity with Microsoft Exchange. This package was SPECIFICALLY created to support evolution-mapi and may not work for any other purpose."
arch=('i686' 'x86_64')
url="http://www.openchange.org"
license=('GPL3')
depends=('samba4=4.0.0A13' 'popt' 'libical' 'sqlite3' 'file' 'boost' 'zlib')
makedepends=('ccache' 'python2' 'subversion' 'git' 'docbook-xsl' 'libxslt' 'tevent')
options=(!makeflags)
source=("http://www.openchange.org/phocadownload/userupload/${pkgname}-${pkgver}-${_codename}.tar.gz")
md5sums=('e9225cd46347e0dfc69a1a4879a6a669')
_prefix="/opt/samba4"

build() {
	# The build process expects python to be python2,
	# so that's what it will be.
	#mkdir -p ${srcdir}/bin
	#if [[ ! -h ${srcdir}/bin/python ]]; then
		#ln -s /usr/bin/python2 ${srcdir}/bin/python
	#fi
	#if [[ ! -h ${srcdir}/bin/python-config ]]; then
		#ln -s /usr/bin/python2-config ${srcdir}/bin/python-config
	#fi
	#export PATH="${srcdir}/bin:${PATH}"
  sed -i -e "s|/usr/bin/env python$|/usr/bin/env python2|" \
         -e "s|python-config$|python2-config|" \
         -e "s|bin/python$|bin/python2|" \
    $(find ${srcdir}/${pkgname}-${pkgver}-${_codename} -name '*.py')
  sed -i -e "s|/usr/bin/python$|/usr/bin/python2|" \
    $(find ${srcdir}/${pkgname}-${pkgver}-${_codename}/  -type f)
  export PYTHON=/usr/bin/python2
  sed -i -e "s|python-config|python2-config|" \
    $(find ${srcdir}/${pkgname}-${pkgver}-${_codename}/ -name 'configure.ac')

	#export PATH="${srcdir}/bin:${PATH}"
	cd ${srcdir}/${pkgname}-${pkgver}-${_codename}
	./autogen.sh
	export PKG_CONFIG_PATH=${_prefix}/lib/pkgconfig:$PKG_CONFIG_PATH
	export BOOST_LIB_SUFFIX="-mt"
	./configure --prefix=${_prefix}
	make || return 1
}

package() {
	_pyver=`python2 -c 'import sys; print(sys.version[:3])'`

	#export PATH="${srcdir}/bin:${PATH}"

	cd ${srcdir}/${pkgname}-${pkgver}-${_codename}
	make DESTDIR="$pkgdir/" install

	cd ${pkgdir}/${_prefix}/lib/
	ln -s libmapi.so libmapi.so.0

	find ${pkgdir}/${_prefix}/lib/python${_pyver}/site-packages/ -name '*.py' | \
		xargs sed -i "s|#!/usr/bin/env python$|#!/usr/bin/env python2|"
}
